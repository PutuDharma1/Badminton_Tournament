// =====================
//  Datasource & Client
// =====================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // contoh: postgresql://user:pass@localhost:5432/badminton_db?schema=public
}

generator client {
  provider  = "prisma-client-py"
  interface = "sync"
}

// =====================
//        ENUMS
// =====================

enum UserRole {
  ADMIN
  COMMITTEE
  REFEREE
}

enum Gender {
  MALE
  FEMALE
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum MatchStatus {
  SCHEDULED
  ONGOING
  FINISHED
  WALKOVER
}

// =====================
//       MAIN MODELS
// =====================

// User sistem (panitia, admin, wasit)
model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(COMMITTEE)

  // relasi
  tournamentsCreated Tournament[] @relation("TournamentCreatedBy")
  matchesRefereed    Match[]      @relation("MatchReferee")
}

// Turnamen (event)
model Tournament {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  location    String
  startDate   DateTime
  endDate     DateTime
  description String?

  // siapa yang buat turnamen
  createdById Int?
  createdBy   User? @relation("TournamentCreatedBy", fields: [createdById], references: [id])

  // relasi
  categories   Category[]
  courts       Court[]
  participants Participant[]
  teams        Team[]
  matches      Match[]
}

// Kategori (U15 Boys Intermediate, dsb)
model Category {
  id     Int    @id @default(autoincrement())
  name   String
  gender Gender
  level  Level
  minAge Int
  maxAge Int

  tournamentId Int
  tournament   Tournament @relation(fields: [tournamentId], references: [id])

  participants Participant[]
  teams        Team[]
  matches      Match[]
}

// Peserta (player individual)
model Participant {
  id        Int      @id @default(autoincrement())
  fullName  String
  birthDate DateTime
  gender    Gender
  email     String?
  phone     String?
  isActive  Boolean  @default(true)

  tournamentId Int
  tournament   Tournament @relation(fields: [tournamentId], references: [id])

  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id])

  // jika main double, dia bisa masuk beberapa tim
  teamLinks TeamParticipant[]
}

// Tim (untuk double; kalau single bisa dianggap 1 player per team)
model Team {
  id   Int    @id @default(autoincrement())
  name String

  tournamentId Int
  tournament   Tournament @relation(fields: [tournamentId], references: [id])

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  // anggota tim
  players TeamParticipant[]

  // pertandingan
  homeMatches Match[] @relation("HomeTeam")
  awayMatches Match[] @relation("AwayTeam")
  winnerOf    Match[] @relation("WinnerTeam")
}

// Tabel penghubung Team <-> Participant (many-to-many)
model TeamParticipant {
  id            Int @id @default(autoincrement())
  teamId        Int
  participantId Int

  team        Team        @relation(fields: [teamId], references: [id])
  participant Participant @relation(fields: [participantId], references: [id])

  @@unique([teamId, participantId])
}

// Lapangan / court
model Court {
  id           Int     @id @default(autoincrement())
  name         String
  locationNote String?

  tournamentId Int
  tournament   Tournament @relation(fields: [tournamentId], references: [id])

  matches Match[]
}

// Jadwal & hasil pertandingan
model Match {
  id          Int         @id @default(autoincrement())
  round       Int
  groupCode   String? // untuk round robin (Group A, B, dll)
  scheduledAt DateTime?
  startedAt   DateTime?
  finishedAt  DateTime?
  status      MatchStatus @default(SCHEDULED)

  homeScore Int? // total poin / game menurut desainmu
  awayScore Int?

  tournamentId Int
  tournament   Tournament @relation(fields: [tournamentId], references: [id])

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  courtId Int?
  court   Court? @relation(fields: [courtId], references: [id])

  homeTeamId Int
  homeTeam   Team @relation("HomeTeam", fields: [homeTeamId], references: [id])

  awayTeamId Int
  awayTeam   Team @relation("AwayTeam", fields: [awayTeamId], references: [id])

  winnerTeamId Int?
  winnerTeam   Team? @relation("WinnerTeam", fields: [winnerTeamId], references: [id])

  refereeId Int?
  referee   User? @relation("MatchReferee", fields: [refereeId], references: [id])
}
